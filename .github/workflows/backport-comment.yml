name: Backport Command

on:
  issue_comment:
    types: [created]

jobs:
  backport-label:
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/backport-to-')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Parse and add backport labels
        env:
          GH_TOKEN: ${{ secrets.PYMILVUS_BOT_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Extract all /backport-to-xxx patterns from comment
          # Supports: /backport-to-2.6, /backport-to-2.6 2.5 2.4, multiple lines, etc.
          
          # Extract all /backport-to-XXX patterns
          BACKPORT_COMMANDS=$(echo "$COMMENT_BODY" | grep -oP '/backport-to-\S+' || true)
          
          if [ -z "$BACKPORT_COMMANDS" ]; then
            echo "::error::No /backport-to- commands found"
            exit 1
          fi
          
          # Extract branch names
          BRANCHES=""
          while IFS= read -r cmd; do
            [ -z "$cmd" ] && continue
            branch_part=$(echo "$cmd" | sed 's|^/backport-to-||')
            for b in $branch_part; do
              BRANCHES="${BRANCHES}${b}"$'\n'
            done
          done <<< "$BACKPORT_COMMANDS"
          
          # Handle space-separated format: /backport-to-2.6 2.5 2.4
          EXTRA=$(echo "$COMMENT_BODY" | grep -oP '(?<=/backport-to-\S)\s+[\d.]+(\s+[\d.]+)*' | tr ' ' '\n' || true)
          if [ -n "$EXTRA" ]; then
            BRANCHES="${BRANCHES}${EXTRA}"$'\n'
          fi
          
          # Deduplicate and remove empty lines
          ALL_BRANCHES=$(echo "$BRANCHES" | sort -u | grep -v '^$')
          
          if [ -z "$ALL_BRANCHES" ]; then
            echo "::error::No valid branches found"
            exit 1
          fi
          
          echo "Found branches:"
          echo "$ALL_BRANCHES"
          
          while IFS= read -r BRANCH; do
            [ -z "$BRANCH" ] && continue
            
            echo "Processing branch: $BRANCH"
            
            # Check if branch exists
            if ! gh api "/repos/${{ github.repository }}/branches/$BRANCH" --silent 2>/dev/null; then
              echo "::warning::Branch '$BRANCH' does not exist, skipping"
              continue
            fi
            
            LABEL="backport-to-$BRANCH"
            echo "Adding label: $LABEL"
            gh pr edit "$PR_NUMBER" --add-label "$LABEL" --repo ${{ github.repository }} || echo "::warning::Failed to add label $LABEL"
          done <<< "$ALL_BRANCHES"

name: Backport Command

on:
  issue_comment:
    types: [created]

jobs:
  backport-label:
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/backport-to-')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Parse and add backport labels
        env:
          GH_TOKEN: ${{ secrets.PYMILVUS_BOT_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Check if PR targets master branch
          BASE_BRANCH=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json baseRefName --jq '.baseRefName')
          if [ "$BASE_BRANCH" != "master" ]; then
            echo "::notice::Backport command only works on PRs targeting master branch (current: $BASE_BRANCH)"
            exit 0
          fi
          
          # Get all existing backport-to-* labels from the repository
          EXISTING_LABELS=$(gh label list --repo ${{ github.repository }} --json name --jq '.[].name' | grep '^backport-to-' || true)
          
          if [ -z "$EXISTING_LABELS" ]; then
            echo "::error::No backport-to-* labels found in repository"
            gh pr comment "$PR_NUMBER" --body "❌ No \`backport-to-*\` labels are configured in this repository." --repo ${{ github.repository }}
            exit 1
          fi
          
          # Extract valid branches from existing labels
          VALID_BRANCHES=$(echo "$EXISTING_LABELS" | sed 's|^backport-to-||' | sort)
          echo "Valid branches: $VALID_BRANCHES"
          
          # Extract all /backport-to-xxx patterns and their arguments from comment
          # Supports: /backport-to-2.6, /backport-to-2.6 2.5 2.4, multiple lines, etc.
          REQUESTED_BRANCHES=""
          
          # Process each line that contains /backport-to-
          while IFS= read -r line; do
            # Check if line contains /backport-to-
            if echo "$line" | grep -q '/backport-to-'; then
              # Extract the part after /backport-to- until end of line or next command
              # First get the primary branch (immediately after /backport-to-)
              primary=$(echo "$line" | grep -oP '/backport-to-\S+' | sed 's|^/backport-to-||')
              if [ -n "$primary" ]; then
                REQUESTED_BRANCHES="${REQUESTED_BRANCHES}${primary}"$'\n'
              fi
              
              # Then get any space-separated additional branches (numbers/versions only)
              # Match pattern: /backport-to-X.X followed by space-separated version numbers
              extras=$(echo "$line" | grep -oP '/backport-to-\S+\s+\K[\d.]+(\s+[\d.]+)*' || true)
              if [ -n "$extras" ]; then
                for b in $extras; do
                  REQUESTED_BRANCHES="${REQUESTED_BRANCHES}${b}"$'\n'
                done
              fi
            fi
          done <<< "$COMMENT_BODY"
          
          if [ -z "$REQUESTED_BRANCHES" ]; then
            echo "::error::No /backport-to- commands found"
            exit 1
          fi
          
          # Deduplicate and remove empty lines
          ALL_REQUESTED=$(echo "$REQUESTED_BRANCHES" | sort -u | grep -v '^$')
          
          if [ -z "$ALL_REQUESTED" ]; then
            echo "::error::No valid branches found in comment"
            exit 1
          fi
          
          echo "Requested branches:"
          echo "$ALL_REQUESTED"
          
          SUCCESS_LABELS=""
          INVALID_BRANCHES=""
          
          while IFS= read -r BRANCH; do
            [ -z "$BRANCH" ] && continue
            
            LABEL="backport-to-$BRANCH"
            echo "Processing: $LABEL"
            
            # Check if label exists in repository
            if ! echo "$EXISTING_LABELS" | grep -qx "$LABEL"; then
              echo "::warning::Label '$LABEL' does not exist"
              INVALID_BRANCHES="${INVALID_BRANCHES}- \`$BRANCH\`"$'\n'
              continue
            fi
            
            echo "Adding label: $LABEL"
            if gh pr edit "$PR_NUMBER" --add-label "$LABEL" --repo ${{ github.repository }}; then
              SUCCESS_LABELS="${SUCCESS_LABELS}- \`$LABEL\`"$'\n'
            else
              INVALID_BRANCHES="${INVALID_BRANCHES}- \`$BRANCH\` (failed to add)"$'\n'
            fi
          done <<< "$ALL_REQUESTED"
          
          # If there are invalid branches, comment to notify user
          if [ -n "$INVALID_BRANCHES" ]; then
            # Format valid branches for display
            VALID_LIST=$(echo "$VALID_BRANCHES" | while read -r b; do [ -n "$b" ] && echo "- \`$b\`"; done)
            
            COMMENT="❌ **Invalid backport target(s):**"$'\n'"$INVALID_BRANCHES"$'\n'
            COMMENT="${COMMENT}"$'\n'"**Available targets:**"$'\n'"$VALID_LIST"
            
            gh pr comment "$PR_NUMBER" --body "$COMMENT" --repo ${{ github.repository }}
          fi
          
          if [ -n "$SUCCESS_LABELS" ]; then
            echo "Successfully added labels:"
            echo "$SUCCESS_LABELS"
          fi
